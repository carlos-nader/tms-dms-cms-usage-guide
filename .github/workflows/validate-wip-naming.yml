name: Validate WIP and ARCHIVE File Naming

on:
  push:
    branches:
      - main
      - develop

jobs:
  validate-filenames:
    runs-on: ubuntu-latest
    name: Check WIP/ARCHIVE Filenames Against Conventions

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: List all WIP and ARCHIVE files (DEBUG)
        run: |
          echo "=================================="
          echo "DEBUG: ALL WIP/ARCHIVE FILES IN REPO"
          echo "=================================="
          find . -path "./WIP/*" -o -path "./ARCHIVE/*" | head -50

      - name: Validate WIP and ARCHIVE files
        run: |
          set +e
          VIOLATIONS=0
          
          echo ""
          echo "=================================="
          echo "üîç VALIDATING FILE NAMING"
          echo "=================================="
          
          # Get list of all WIP and ARCHIVE files
          ALL_FILES=$(find . -type f \( -path "./WIP/*" -o -path "./ARCHIVE/*" \) ! -path "./.git/*" ! -path "./.*" | sed 's|^\./||' | sort)
          
          if [ -z "$ALL_FILES" ]; then
            echo "‚ÑπÔ∏è  No WIP or ARCHIVE files found."
            exit 0
          fi
          
          echo "Found files to validate:"
          echo "$ALL_FILES" | sed 's/^/  ‚Üí /'
          echo ""
          
          while IFS= read -r FILE; do
            [ -z "$FILE" ] && continue
            
            FILENAME=$(basename "$FILE")
            DIRPATH=$(dirname "$FILE")
            VALID=0
            TYPE="UNKNOWN"
            
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "File: $FILE"
            echo "  Filename: '$FILENAME'"
            echo "  Directory: '$DIRPATH'"
            
            # Check if in valid directory
            if [[ "$DIRPATH" != "WIP" && "$DIRPATH" != "WIP/GUIDE" && "$DIRPATH" != "ARCHIVE/WIP" && "$DIRPATH" != "ARCHIVE/GUIDE" && "$DIRPATH" != "ARCHIVE/GUIDE-STRUCTURE" ]]; then
              echo "  ‚ùå Invalid directory (not in WIP or ARCHIVE structure)"
              VIOLATIONS=$((VIOLATIONS + 1))
              echo ""
              continue
            fi
            
            # Guide snapshots
            if [[ "$DIRPATH" == "WIP/GUIDE" ]] || [[ "$DIRPATH" == "ARCHIVE/GUIDE" ]]; then
              if [[ "$FILENAME" =~ ^guide-v[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?-[0-9]{8}\.tex$ ]]; then
                echo "  ‚úÖ Valid GUIDE snapshot"
                VALID=1
              else
                echo "  ‚ùå Invalid GUIDE snapshot (expected: guide-vX.Y.Z-YYYYMMDD.tex)"
              fi
            
            # Ignored directory
            elif [[ "$DIRPATH" == "ARCHIVE/GUIDE-STRUCTURE" ]]; then
              echo "  ‚úÖ GUIDE-STRUCTURE (ignored)"
              VALID=1
            
            # WIP content
            elif [[ "$DIRPATH" == "WIP" ]] || [[ "$DIRPATH" == "ARCHIVE/WIP" ]]; then
              if [[ "$FILENAME" =~ ^chapter-C[1-7]-[a-z0-9]+(-[a-z0-9]+)*-(dev|review|final|approved|deprecated)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.tex$ ]]; then
                echo "  ‚úÖ Valid CHAPTER"
                VALID=1
              elif [[ "$FILENAME" =~ ^section-C[1-7](-S[0-9]+)*-[a-z0-9]+(-[a-z0-9]+)*-(dev|review|final|approved|deprecated)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.tex$ ]]; then
                echo "  ‚úÖ Valid SECTION"
                VALID=1
              elif [[ "$FILENAME" =~ ^table-C[1-7]-[A-Z0-9]+-[A-Z]{3,}-(dev|review|final|approved|deprecated)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.tex$ ]]; then
                echo "  ‚úÖ Valid TABLE"
                VALID=1
              elif [[ "$FILENAME" =~ ^notes-(C[1-7]|GEN)-[a-z0-9]+(-[a-z0-9]+)*-(research|snippet|outline|questions|reference|example)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.md$ ]]; then
                echo "  ‚úÖ Valid NOTES"
                VALID=1
              elif [[ "$FILENAME" =~ ^visual-C[1-7]-[a-z0-9]+(-[a-z0-9]+)*-(diagram|flowchart|schematic|reference|illustration)-(dev|review|final|approved|deprecated)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.(svg|pdf|png|tex)$ ]]; then
                echo "  ‚úÖ Valid VISUAL"
                VALID=1
              else
                echo "  ‚ùå Invalid WIP file (doesn't match any pattern)"
                echo "     Expected: chapter-/section-/table-/notes-/visual-"
              fi
            fi
            
            if [ $VALID -ne 1 ]; then
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
            echo ""
          done <<< "$ALL_FILES"
          
          echo "=================================="
          if [ $VIOLATIONS -gt 0 ]; then
            echo "‚ùå Found $VIOLATIONS filename violations"
            exit 1
          else
            echo "‚úÖ All filenames are valid!"
            exit 0
          fi
