name: Validate WIP and ARCHIVE File Naming

on:
  push:
    branches:
      - main
      - develop
    paths:
      - 'WIP/**'
      - 'ARCHIVE/**'
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'WIP/**'
      - 'ARCHIVE/**'

jobs:
  validate-filenames:
    runs-on: ubuntu-latest
    name: Check WIP/ARCHIVE Filenames Against Conventions

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed_files
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '^(WIP|ARCHIVE)/' || true)
          else
            if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
              FILES=$(git ls-tree -r --name-only HEAD | grep -E '^(WIP|ARCHIVE)/' || true)
            else
              FILES=$(git diff --name-only ${{ github.event.before }} HEAD | grep -E '^(WIP|ARCHIVE)/' || true)
            fi
          fi
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Validate filenames against naming conventions
        env:
          FILES: ${{ steps.changed_files.outputs.files }}
        run: |
          set +e
          VIOLATIONS=0
          
          # Regex patterns
          CHAPTER_REGEX='^chapter-C([1-7])-([a-z0-9]+(-[a-z0-9]+)*)-(dev|review|final|approved|deprecated)-([0-9]{4}-[0-9]{2}-[0-9]{2})\.tex$'
          SECTION_REGEX='^section-C([1-7])(-S[0-9]+)*-([a-z0-9]+(-[a-z0-9]+)*)-(dev|review|final|approved|deprecated)-([0-9]{4}-[0-9]{2}-[0-9]{2})\.tex$'
          TABLE_REGEX='^table-C([1-7])-([A-Z0-9]+)-([A-Z]{3,})-(dev|review|final|approved|deprecated)-([0-9]{4}-[0-9]{2}-[0-9]{2})\.tex$'
          NOTES_REGEX='^notes-(C[1-7]|GEN)-([a-z0-9]+(-[a-z0-9]+)*)-(research|snippet|outline|questions|reference|example)-([0-9]{4}-[0-9]{2}-[0-9]{2})\.md$'
          VISUAL_REGEX='^visual-C([1-7])-([a-z0-9]+(-[a-z0-9]+)*)-(diagram|flowchart|schematic|reference|illustration)-(dev|review|final|approved|deprecated)-([0-9]{4}-[0-9]{2}-[0-9]{2})\.(svg|pdf|png|tex)$'
          GUIDE_REGEX='^guide-v([0-9]+)\.([0-9]+)\.([0-9]+)(\.([0-9]+))?-([0-9]{8})\.tex$'
          
          echo "üîç Validating file naming conventions..."
          echo ""
          
          if [ -z "$FILES" ]; then
            echo "‚ÑπÔ∏è  No WIP or ARCHIVE files changed."
            exit 0
          fi
          
          while IFS= read -r FILE; do
            [ -z "$FILE" ] && continue
            
            FILENAME=$(basename "$FILE")
            DIRPATH=$(dirname "$FILE")
            VALID=0
            TYPE="UNKNOWN"
            EXPECTED_PATTERN=""
            
            # Determine validation rules based on path
            if [[ "$DIRPATH" =~ ^WIP/GUIDE$ || "$DIRPATH" =~ ^ARCHIVE/GUIDE$ ]]; then
              # Guide snapshots: VERSION-SYSTEM-v4.2.1
              if [[ "$FILENAME" =~ ^guide- ]]; then
                if echo "$FILENAME" | grep -qE "$GUIDE_REGEX"; then
                  VALID=1
                fi
                TYPE="GUIDE"
                EXPECTED_PATTERN="guide-vMAJOR.MINOR.PATCH[.SUBPATCH]-YYYYMMDD.tex"
              fi
            elif [[ "$DIRPATH" =~ ^ARCHIVE/GUIDE-STRUCTURE ]]; then
              # IGNORE: no validation required for GUIDE-STRUCTURE
              VALID=1
              TYPE="GUIDE-STRUCTURE (ignored)"
            elif [[ "$DIRPATH" =~ ^(WIP|ARCHIVE/WIP)$ || "$DIRPATH" =~ ^WIP/$ || "$DIRPATH" =~ ^ARCHIVE/WIP/$ ]]; then
              # WIP files: WIP-NAMING-v1.4
              if [[ "$FILENAME" =~ ^chapter- ]]; then
                if echo "$FILENAME" | grep -qE "$CHAPTER_REGEX"; then
                  VALID=1
                fi
                TYPE="CHAPTER"
                EXPECTED_PATTERN="chapter-C{1-7}-{title}-{status}-YYYY-MM-DD.tex"
              elif [[ "$FILENAME" =~ ^section- ]]; then
                if echo "$FILENAME" | grep -qE "$SECTION_REGEX"; then
                  VALID=1
                fi
                TYPE="SECTION"
                EXPECTED_PATTERN="section-C{1-7}[-S{N}]...-{title}-{status}-YYYY-MM-DD.tex"
              elif [[ "$FILENAME" =~ ^table- ]]; then
                if echo "$FILENAME" | grep -qE "$TABLE_REGEX"; then
                  VALID=1
                fi
                TYPE="TABLE"
                EXPECTED_PATTERN="table-C{1-7}-{CONTEXT}-{TMS|DMS|CMS}-{status}-YYYY-MM-DD.tex"
              elif [[ "$FILENAME" =~ ^notes- ]]; then
                if echo "$FILENAME" | grep -qE "$NOTES_REGEX"; then
                  VALID=1
                fi
                TYPE="NOTES"
                EXPECTED_PATTERN="notes-C{1-7}|GEN-{topic}-{type}-YYYY-MM-DD.md"
              elif [[ "$FILENAME" =~ ^visual- ]]; then
                if echo "$FILENAME" | grep -qE "$VISUAL_REGEX"; then
                  VALID=1
                fi
                TYPE="VISUAL"
                EXPECTED_PATTERN="visual-C{1-7}-{description}-{type}-{status}-YYYY-MM-DD.{svg|pdf|png|tex}"
              fi
            fi
            
            if [ $VALID -eq 1 ]; then
              echo "‚úÖ $TYPE: $FILE"
            else
              echo "‚ùå $TYPE: $FILE"
              if [ -n "$EXPECTED_PATTERN" ]; then
                echo "   Expected: $EXPECTED_PATTERN"
              fi
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done <<< "$FILES"
          
          echo ""
          if [ $VIOLATIONS -gt 0 ]; then
            echo "‚ùå Found $VIOLATIONS filename violations"
            exit 1
          else
            echo "‚úÖ All filenames are valid!"
            exit 0
          fi

      - name: Comment on PR (if violation)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Filename Validation Failed**\n\nOne or more files in WIP/ or ARCHIVE/ do not follow naming conventions. Please review the logs and rename files accordingly.\n\nRefer to:\n- WIP-NAMING-v1.4.md (for WIP and ARCHIVE/WIP files)\n- VERSION-SYSTEM-v4.2.1.md (for guide snapshots in WIP/GUIDE/ and ARCHIVE/GUIDE/)'
            })
