name: Validate WIP and ARCHIVE File Naming

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

jobs:
  validate-filenames:
    if: contains(github.event.head_commit.modified, 'WIP/') || contains(github.event.head_commit.modified, 'ARCHIVE/') || contains(github.event.pull_request.body, '')
    runs-on: ubuntu-latest
    name: Check WIP/ARCHIVE Filenames Against Conventions

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed_files
        run: |
          echo "Detecting changed files..."
          
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "Event: Pull Request"
            FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD 2>/dev/null | grep -E '^(WIP|ARCHIVE)/' || echo "")
          else
            echo "Event: Push"
            if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
              echo "Initial commit detected"
              FILES=$(git ls-tree -r --name-only HEAD | grep -E '^(WIP|ARCHIVE)/' || echo "")
            else
              echo "Regular push"
              FILES=$(git diff --name-only ${{ github.event.before }} HEAD 2>/dev/null | grep -E '^(WIP|ARCHIVE)/' || echo "")
            fi
          fi
          
          echo "Changed WIP/ARCHIVE files:"
          echo "$FILES"
          echo ""
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Validate filenames against naming conventions
        env:
          FILES: ${{ steps.changed_files.outputs.files }}
        run: |
          set +e
          VIOLATIONS=0
          
          echo "üîç Validating file naming conventions..."
          echo ""
          
          if [ -z "$FILES" ]; then
            echo "‚ÑπÔ∏è  No WIP or ARCHIVE files changed."
            exit 0
          fi
          
          while IFS= read -r FILE; do
            [ -z "$FILE" ] && continue
            
            FILENAME=$(basename "$FILE")
            DIRPATH=$(dirname "$FILE")
            VALID=0
            TYPE="UNKNOWN"
            EXPECTED_PATTERN=""
            
            # Determine validation rules based on path
            if [[ "$DIRPATH" == "WIP/GUIDE" ]] || [[ "$DIRPATH" == "ARCHIVE/GUIDE" ]]; then
              if [[ "$FILENAME" =~ ^guide-v[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?-[0-9]{8}\.tex$ ]]; then
                VALID=1
              fi
              TYPE="GUIDE"
              EXPECTED_PATTERN="guide-vMAJOR.MINOR.PATCH[.SUBPATCH]-YYYYMMDD.tex"
            elif [[ "$DIRPATH" == "ARCHIVE/GUIDE-STRUCTURE" ]]; then
              VALID=1
              TYPE="GUIDE-STRUCTURE (ignored)"
            elif [[ "$DIRPATH" == "WIP" ]] || [[ "$DIRPATH" == "ARCHIVE/WIP" ]]; then
              if [[ "$FILENAME" =~ ^chapter-C[1-7]-[a-z0-9]+(-[a-z0-9]+)*-(dev|review|final|approved|deprecated)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.tex$ ]]; then
                VALID=1
                TYPE="CHAPTER"
                EXPECTED_PATTERN="chapter-C{1-7}-{title}-{status}-YYYY-MM-DD.tex"
              elif [[ "$FILENAME" =~ ^section-C[1-7](-S[0-9]+)*-[a-z0-9]+(-[a-z0-9]+)*-(dev|review|final|approved|deprecated)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.tex$ ]]; then
                VALID=1
                TYPE="SECTION"
                EXPECTED_PATTERN="section-C{1-7}[-S{N}]...-{title}-{status}-YYYY-MM-DD.tex"
              elif [[ "$FILENAME" =~ ^table-C[1-7]-[A-Z0-9]+-[A-Z]{3,}-(dev|review|final|approved|deprecated)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.tex$ ]]; then
                VALID=1
                TYPE="TABLE"
                EXPECTED_PATTERN="table-C{1-7}-{CONTEXT}-{TMS|DMS|CMS}-{status}-YYYY-MM-DD.tex"
              elif [[ "$FILENAME" =~ ^notes-(C[1-7]|GEN)-[a-z0-9]+(-[a-z0-9]+)*-(research|snippet|outline|questions|reference|example)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.md$ ]]; then
                VALID=1
                TYPE="NOTES"
                EXPECTED_PATTERN="notes-C{1-7}|GEN-{topic}-{type}-YYYY-MM-DD.md"
              elif [[ "$FILENAME" =~ ^visual-C[1-7]-[a-z0-9]+(-[a-z0-9]+)*-(diagram|flowchart|schematic|reference|illustration)-(dev|review|final|approved|deprecated)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.(svg|pdf|png|tex)$ ]]; then
                VALID=1
                TYPE="VISUAL"
                EXPECTED_PATTERN="visual-C{1-7}-{description}-{type}-{status}-YYYY-MM-DD.{svg|pdf|png|tex}"
              else
                TYPE="UNKNOWN"
                EXPECTED_PATTERN="chapter-/section-/table-/notes-/visual- (see WIP-NAMING-v1.4.md)"
              fi
            fi
            
            if [ $VALID -eq 1 ]; then
              echo "‚úÖ $TYPE: $FILE"
            else
              echo "‚ùå $TYPE: $FILE"
              if [ -n "$EXPECTED_PATTERN" ]; then
                echo "   Expected: $EXPECTED_PATTERN"
              fi
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done <<< "$FILES"
          
          echo ""
          if [ $VIOLATIONS -gt 0 ]; then
            echo "‚ùå Found $VIOLATIONS filename violations"
            exit 1
          else
            echo "‚úÖ All filenames are valid!"
            exit 0
          fi

      - name: Comment on PR (if violation)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Filename Validation Failed**\n\nOne or more files in WIP/ or ARCHIVE/ do not follow naming conventions. Please review the logs and rename files accordingly.\n\nRefer to:\n- WIP-NAMING-v1.4.md (for WIP and ARCHIVE/WIP files)\n- VERSION-SYSTEM-v4.2.1.md (for guide snapshots in WIP/GUIDE/ and ARCHIVE/GUIDE/)'
            })
