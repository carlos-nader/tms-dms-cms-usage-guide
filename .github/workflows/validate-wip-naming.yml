name: Validate WIP and ARCHIVE File Naming

on:
  push:
    branches:
      - main
      - develop

jobs:
  validate-filenames:
    runs-on: ubuntu-latest
    name: Check WIP/ARCHIVE Filenames Against Conventions

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files and validate
        run: |
          set +e
          VIOLATIONS=0
          
          echo "=================================="
          echo "üîç VALIDATING FILE NAMING CONVENTIONS"
          echo "=================================="
          echo ""
          
          # Get changed files
          echo "Step 1: Detecting changed files..."
          if [ "${{ github.event.before }}" == "0000000000000000000000000000000000000000" ]; then
            echo "  ‚Üí Initial commit detected"
            FILES=$(git ls-tree -r --name-only HEAD | grep -E '^(WIP|ARCHIVE)/')
          else
            echo "  ‚Üí Regular push (before: ${{ github.event.before }})"
            FILES=$(git diff --name-only ${{ github.event.before }} HEAD | grep -E '^(WIP|ARCHIVE)/')
          fi
          
          echo ""
          echo "Step 2: Found WIP/ARCHIVE files:"
          if [ -z "$FILES" ]; then
            echo "  ‚ÑπÔ∏è  No WIP or ARCHIVE files changed."
            exit 0
          fi
          echo "$FILES" | sed 's/^/  ‚Üí /'
          echo ""
          echo "Step 3: Validating each file..."
          echo ""
          
          while IFS= read -r FILE; do
            [ -z "$FILE" ] && continue
            
            FILENAME=$(basename "$FILE")
            DIRPATH=$(dirname "$FILE")
            VALID=0
            TYPE="UNKNOWN"
            EXPECTED_PATTERN=""
            
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "File: $FILE"
            echo "  Filename: $FILENAME"
            echo "  Directory: $DIRPATH"
            echo ""
            
            # Validate based on directory path
            if [[ "$DIRPATH" == "WIP/GUIDE" ]] || [[ "$DIRPATH" == "ARCHIVE/GUIDE" ]]; then
              echo "  Path type: GUIDE snapshot directory"
              GUIDE_PATTERN="^guide-v[0-9]+\.[0-9]+\.[0-9]+(\.[0-9]+)?-[0-9]{8}\.tex$"
              echo "  Testing regex: $GUIDE_PATTERN"
              if [[ "$FILENAME" =~ $GUIDE_PATTERN ]]; then
                echo "  ‚úÖ MATCHED - Valid GUIDE"
                VALID=1
              else
                echo "  ‚ùå NO MATCH - Invalid GUIDE"
              fi
              TYPE="GUIDE"
              EXPECTED_PATTERN="guide-vMAJOR.MINOR.PATCH[.SUBPATCH]-YYYYMMDD.tex"
            
            elif [[ "$DIRPATH" == "ARCHIVE/GUIDE-STRUCTURE" ]]; then
              echo "  Path type: GUIDE-STRUCTURE (ignored)"
              VALID=1
              TYPE="GUIDE-STRUCTURE (ignored)"
            
            elif [[ "$DIRPATH" == "WIP" ]] || [[ "$DIRPATH" == "ARCHIVE/WIP" ]]; then
              echo "  Path type: WIP content directory"
              
              CHAPTER_PATTERN="^chapter-C[1-7]-[a-z0-9]+(-[a-z0-9]+)*-(dev|review|final|approved|deprecated)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.tex$"
              echo "  Testing CHAPTER regex: $CHAPTER_PATTERN"
              if [[ "$FILENAME" =~ $CHAPTER_PATTERN ]]; then
                echo "  ‚úÖ MATCHED CHAPTER"
                VALID=1
                TYPE="CHAPTER"
                EXPECTED_PATTERN="chapter-C{1-7}-{title}-{status}-YYYY-MM-DD.tex"
              else
                SECTION_PATTERN="^section-C[1-7](-S[0-9]+)*-[a-z0-9]+(-[a-z0-9]+)*-(dev|review|final|approved|deprecated)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.tex$"
                echo "  Testing SECTION regex: $SECTION_PATTERN"
                if [[ "$FILENAME" =~ $SECTION_PATTERN ]]; then
                  echo "  ‚úÖ MATCHED SECTION"
                  VALID=1
                  TYPE="SECTION"
                  EXPECTED_PATTERN="section-C{1-7}[-S{N}]...-{title}-{status}-YYYY-MM-DD.tex"
                else
                  TABLE_PATTERN="^table-C[1-7]-[A-Z0-9]+-[A-Z]{3,}-(dev|review|final|approved|deprecated)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.tex$"
                  echo "  Testing TABLE regex: $TABLE_PATTERN"
                  if [[ "$FILENAME" =~ $TABLE_PATTERN ]]; then
                    echo "  ‚úÖ MATCHED TABLE"
                    VALID=1
                    TYPE="TABLE"
                    EXPECTED_PATTERN="table-C{1-7}-{CONTEXT}-{TMS|DMS|CMS}-{status}-YYYY-MM-DD.tex"
                  else
                    NOTES_PATTERN="^notes-(C[1-7]|GEN)-[a-z0-9]+(-[a-z0-9]+)*-(research|snippet|outline|questions|reference|example)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.md$"
                    echo "  Testing NOTES regex: $NOTES_PATTERN"
                    if [[ "$FILENAME" =~ $NOTES_PATTERN ]]; then
                      echo "  ‚úÖ MATCHED NOTES"
                      VALID=1
                      TYPE="NOTES"
                      EXPECTED_PATTERN="notes-C{1-7}|GEN-{topic}-{type}-YYYY-MM-DD.md"
                    else
                      VISUAL_PATTERN="^visual-C[1-7]-[a-z0-9]+(-[a-z0-9]+)*-(diagram|flowchart|schematic|reference|illustration)-(dev|review|final|approved|deprecated)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.(svg|pdf|png|tex)$"
                      echo "  Testing VISUAL regex: $VISUAL_PATTERN"
                      if [[ "$FILENAME" =~ $VISUAL_PATTERN ]]; then
                        echo "  ‚úÖ MATCHED VISUAL"
                        VALID=1
                        TYPE="VISUAL"
                        EXPECTED_PATTERN="visual-C{1-7}-{description}-{type}-{status}-YYYY-MM-DD.{svg|pdf|png|tex}"
                      else
                        echo "  ‚ùå NO MATCH for any WIP file type"
                        TYPE="UNKNOWN"
                        EXPECTED_PATTERN="chapter-/section-/table-/notes-/visual- (see WIP-NAMING-v1.4.md)"
                      fi
                    fi
                  fi
                fi
              fi
            else
              echo "  Path type: UNRECOGNIZED DIRECTORY"
              TYPE="INVALID_PATH"
            fi
            
            echo ""
            if [ $VALID -eq 1 ]; then
              echo "RESULT: ‚úÖ $TYPE - VALID"
            else
              echo "RESULT: ‚ùå $TYPE - INVALID"
              if [ -n "$EXPECTED_PATTERN" ]; then
                echo "Expected pattern: $EXPECTED_PATTERN"
              fi
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
            echo ""
          done <<< "$FILES"
          
          echo "=================================="
          echo "VALIDATION SUMMARY"
          echo "=================================="
          if [ $VIOLATIONS -gt 0 ]; then
            echo "‚ùå Found $VIOLATIONS filename violations"
            echo "=================================="
            exit 1
          else
            echo "‚úÖ All filenames are valid!"
            echo "=================================="
            exit 0
          fi

      - name: Comment on PR (if violation)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Filename Validation Failed**\n\nOne or more files in WIP/ or ARCHIVE/ do not follow naming conventions. Please review the logs and rename files accordingly.\n\nRefer to:\n- WIP-NAMING-v1.4.md (for WIP and ARCHIVE/WIP files)\n- VERSION-SYSTEM-v4.2.1.md (for guide snapshots in WIP/GUIDE/ and ARCHIVE/GUIDE/)'
            })
