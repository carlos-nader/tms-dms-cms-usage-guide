name: Validate WIP and ARCHIVE File Naming

on:
  push:
    branches:
      - main
      - develop

jobs:
  validate-filenames:
    runs-on: ubuntu-latest
    name: Validate WIP/ARCHIVE Filenames Against Conventions

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate all WIP and ARCHIVE files
        run: |
          set +e
          VIOLATIONS=0
          
          echo "=================================="
          echo "üîç VALIDATING FILE NAMING CONVENTIONS"
          echo "=================================="
          echo ""
          
          # Get list of all WIP and ARCHIVE files (both .tex and .pdf)
          ALL_FILES=$(find . -type f \( -path "./WIP/*" -o -path "./ARCHIVE/*" \) ! -path "./.git/*" ! -path "./.*" | sed 's|^\./||' | sort)
          
          if [ -z "$ALL_FILES" ]; then
            echo "‚ÑπÔ∏è  No WIP or ARCHIVE files found."
            exit 0
          fi
          
          echo "Found files to validate:"
          echo "$ALL_FILES" | sed 's/^/  ‚Üí /'
          echo ""
          echo "Validating filenames..."
          echo ""
          
          while IFS= read -r FILE; do
            [ -z "$FILE" ] && continue
            
            FILENAME=$(basename "$FILE")
            DIRPATH=$(dirname "$FILE")
            VALID=0
            TYPE="UNKNOWN"
            
            echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
            echo "File: $FILE"
            echo "  Filename: $FILENAME"
            echo "  Directory: $DIRPATH"
            echo ""
            
            # GUIDE Snapshots: WIP/GUIDE or ARCHIVE/GUIDE
            if [[ "$DIRPATH" == "WIP/GUIDE" ]] || [[ "$DIRPATH" == "ARCHIVE/GUIDE" ]]; then
              TYPE="GUIDE"
              # Pattern: guide-vMAJOR.MINOR.PATCH.SUBPATCH-YYYYMMDD.tex or .pdf
              if [[ "$FILENAME" =~ ^guide-v[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+-[0-9]{8}\.(tex|pdf)$ ]]; then
                echo "  ‚úÖ Valid GUIDE snapshot"
                VALID=1
              else
                echo "  ‚ùå Invalid GUIDE snapshot"
                echo "     Expected: guide-vMAJOR.MINOR.PATCH.SUBPATCH-YYYYMMDD.(tex|pdf)"
                echo "     Example: guide-v0.2.3.1-20260125.tex"
              fi
            
            # IGNORED: ARCHIVE/GUIDE-STRUCTURE
            elif [[ "$DIRPATH" == "ARCHIVE/GUIDE-STRUCTURE" ]]; then
              echo "  ‚ÑπÔ∏è  GUIDE-STRUCTURE (ignored - no validation)"
              VALID=1
              TYPE="IGNORED"
            
            # WIP Content: WIP or ARCHIVE/WIP
            elif [[ "$DIRPATH" == "WIP" ]] || [[ "$DIRPATH" == "ARCHIVE/WIP" ]]; then
              
              # CHAPTER Pattern
              if [[ "$FILENAME" =~ ^chapter-C[1-7]-[a-z0-9]+(-[a-z0-9]+)*-(dev|review|final|approved|deprecated)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.(tex|pdf)$ ]]; then
                echo "  ‚úÖ Valid CHAPTER"
                TYPE="CHAPTER"
                VALID=1
              
              # SECTION Pattern
              elif [[ "$FILENAME" =~ ^section-C[1-7](-S[0-9]+)*-[a-z0-9]+(-[a-z0-9]+)*-(dev|review|final|approved|deprecated)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.(tex|pdf)$ ]]; then
                echo "  ‚úÖ Valid SECTION"
                TYPE="SECTION"
                VALID=1
              
              # TABLE Pattern
              elif [[ "$FILENAME" =~ ^table-C[1-7]-[A-Z0-9]+-[A-Z]{3,}-(dev|review|final|approved|deprecated)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.(tex|pdf)$ ]]; then
                echo "  ‚úÖ Valid TABLE"
                TYPE="TABLE"
                VALID=1
              
              # NOTES Pattern
              elif [[ "$FILENAME" =~ ^notes-(C[1-7]|GEN)-[a-z0-9]+(-[a-z0-9]+)*-(research|snippet|outline|questions|reference|example)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.md$ ]]; then
                echo "  ‚úÖ Valid NOTES"
                TYPE="NOTES"
                VALID=1
              
              # VISUAL Pattern
              elif [[ "$FILENAME" =~ ^visual-C[1-7]-[a-z0-9]+(-[a-z0-9]+)*-(diagram|flowchart|schematic|reference|illustration)-(dev|review|final|approved|deprecated)-[0-9]{4}-[0-9]{2}-[0-9]{2}\.(svg|pdf|png|tex)$ ]]; then
                echo "  ‚úÖ Valid VISUAL"
                TYPE="VISUAL"
                VALID=1
              
              # Unknown WIP file
              else
                echo "  ‚ùå Invalid WIP file"
                echo "     Doesn't match any pattern:"
                echo "       ‚Ä¢ chapter-C{1-7}-{title}-{status}-YYYY-MM-DD.(tex|pdf)"
                echo "       ‚Ä¢ section-C{1-7}[-S{N}]-{title}-{status}-YYYY-MM-DD.(tex|pdf)"
                echo "       ‚Ä¢ table-C{1-7}-{context}-{switch}-{status}-YYYY-MM-DD.(tex|pdf)"
                echo "       ‚Ä¢ notes-C{1-7}|GEN-{topic}-{type}-YYYY-MM-DD.md"
                echo "       ‚Ä¢ visual-C{1-7}-{description}-{type}-{status}-YYYY-MM-DD.{svg|pdf|png|tex}"
                TYPE="UNKNOWN"
              fi
            
            # Invalid directory
            else
              echo "  ‚ùå Invalid directory"
              echo "     Must be in: WIP/, WIP/GUIDE/, ARCHIVE/WIP/, ARCHIVE/GUIDE/, or ARCHIVE/GUIDE-STRUCTURE/"
              TYPE="INVALID_DIR"
            fi
            
            if [ $VALID -ne 1 ]; then
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
            echo ""
          done <<< "$ALL_FILES"
          
          echo "=================================="
          echo "VALIDATION SUMMARY"
          echo "=================================="
          if [ $VIOLATIONS -gt 0 ]; then
            echo "‚ùå Found $VIOLATIONS filename violation(s)"
            echo ""
            echo "For detailed rules, see:"
            echo "  ‚Ä¢ WIP-NAMING-v1.4.md (for WIP files)"
            echo "  ‚Ä¢ VERSION-SYSTEM-v4.2.1.md (for guide snapshots)"
            exit 1
          else
            echo "‚úÖ All filenames are valid!"
            exit 0
          fi

      - name: Comment on PR (if violations found)
        if: failure() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚ùå **Filename Validation Failed**\n\nOne or more files in WIP/ or ARCHIVE/ do not follow naming conventions.\n\n**See workflow logs for details.**\n\nRules:\n- **WIP files**: See WIP-NAMING-v1.4.md\n  - Patterns: chapter-, section-, table-, notes-, visual-\n  - Date format: YYYY-MM-DD\n  - Status: dev, review, final, approved, deprecated\n  - Location: WIP/ (dev/review/final) or ARCHIVE/WIP/ (approved/deprecated)\n  - Formats: .tex or .pdf (for chapter/section/table/guide; .md for notes; .svg|.pdf|.png|.tex for visuals)\n\n- **Guide snapshots**: See VERSION-SYSTEM-v4.2.1.md\n  - Pattern: guide-vMAJOR.MINOR.PATCH.SUBPATCH-YYYYMMDD.(tex|pdf)\n  - Date format: YYYYMMDD (8 digits)\n  - Location: WIP/GUIDE/ or ARCHIVE/GUIDE/'
            })
