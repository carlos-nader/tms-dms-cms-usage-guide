name: Update README on Tag Push

on:
  # Trigger automÃ¡tico: quando vocÃª faz push de uma tag
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+.[0-9]+'
  
  # âœ¨ NOVO: Trigger manual - clique no botÃ£o "Run workflow" no GitHub Actions
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update (e.g., 0.3.2.0)'
        required: true
        default: '0.3.2.0'
        type: string

permissions:
  contents: write

jobs:
  update-readme:
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ Checkout repository with SSH
        uses: actions/checkout@v4
        with:
          ssh-key: ${{ secrets.DEPLOY_KEY }}
          fetch-depth: 0

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # âœ¨ NOVO: Detecta se Ã© automÃ¡tico (tag) ou manual (workflow_dispatch)
      - name: ğŸ” Determine version source
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            # AutomÃ¡tico: pega a tag mais recente
            VERSION=$(git describe --tags --abbrev=0 | sed 's/v//')
            SOURCE="tag"
            echo "ğŸ“Œ Source: Git tag (automatic)"
          else
            # Manual: usa input do usuÃ¡rio
            VERSION="${{ github.event.inputs.version }}"
            SOURCE="manual"
            echo "ğŸ“Œ Source: Manual workflow dispatch"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "source=$SOURCE" >> $GITHUB_OUTPUT
          echo "âœ“ Version determined: $VERSION"

      - name: ğŸ“ Update README with new version
        run: python scripts/update-readme-version.py
        env:
          # Passa a versÃ£o pro script (pode ser usado por ambos os triggers)
          OVERRIDE_VERSION: ${{ steps.version.outputs.version }}

      - name: âš™ï¸ Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: ğŸ’¾ Commit and push changes
        run: |
          if git diff --quiet README.md; then
            echo "â„¹ No changes to commit"
          else
            git add README.md
            git commit -m "chore: update README version to ${{ steps.version.outputs.version }}"
            git push origin main
            echo "âœ“ Changes pushed to repository"
          fi

      # âœ¨ NOVO: Log visual melhorado no resumo do workflow
      - name: âœ… Log update result
        if: success()
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âœ… README updated successfully"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“ Version: ${{ steps.version.outputs.version }}"
          echo "ğŸ“Œ Source: ${{ steps.version.outputs.source }}"
          echo "ğŸ“… Date: $(date +%Y-%m-%d' '%H:%M:%S' '-03)"
          echo "ğŸ”— Repository: ${{ github.repository }}"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

      # Fallback: se algo der errado
      - name: âŒ Log error (if failed)
        if: failure()
        run: |
          echo "âŒ README update FAILED"
          echo "Version attempted: ${{ steps.version.outputs.version }}"
          echo "Source: ${{ steps.version.outputs.source }}"
